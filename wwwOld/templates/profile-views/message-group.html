<ion-view view-title="Message Group" hide-header-search="true" class="grey_bg">
   <ion-content class="post-content-message" ng-class="{'with-attachment': relListing != null}" has-header="true">
   	<ion-refresher
       	pulling-text="Pull to refresh..."
       	on-refresh="doRefresh()">
     	</ion-refresher>
      <div style="float: left; width: 100%;">
        <div class="message-summary-header"
          ng-show="newMsgGroup && (
            (stateParams.groupType == 'Business' && chosenRecipients.length == 0) ||
            (stateParams.groupType == 'Person'))">
          <img src="img/user_images/profile_photo/{{chosenRecipients[0].currentProfilePhotoName}}"
            ng-show="newMsgGroupRecipientDecided && stateParams.groupType == 'Business'" />
          <i class="{'ion-person': chosenRecipients.length == 1, 'ion-ios-people': chosenRecipients.length > 1}"
            ng-show="chosenRecipients.length > 0 && stateParams.groupType == 'Person'"></i>
          <span class="note"
            ng-show="newMsgGroup && !newMsgGroupRecipientDecided">To:</span>
          <span class="main-title"
            ng-show="newMsgGroupRecipientDecided">
                <span ng-repeat="recipient in chosenRecipients">
                    <span ng-if="recipient != chosenRecipients[0]">,&nbsp;</span>
                    {{recipient.displayName}}
                </span>
          </span>
          <form>
            <input type="text" placeholder="{{messageRecipientInputPlaceholderMessage}}" class="recipientSearch"
              ng-show="!newMsgGroupRecipientDecided && newMsgGroup"
              ng-model="currentRecipientSearch.search"
              ng-keyup="conductMessageRecipientSearch(currentRecipientSearch.search)" />
          </form>
        </div>
        <div class="message-possible-recipients-summary"
          ng-show="newMsgGroup && !newMsgGroupRecipientDecided && currentRecipientSearch.search.length > 0">
          <div class="recipient-item"
            ng-repeat="recipient in possibleRecipients">
            <img src="img/user_images/profile_photo/{{recipient.currentProfilePhotoName}}"
                ng-if="recipient.listingType == 'Business'"/>
            <i class="ion-person" style="float: left;"
                ng-if="recipient.listingType == 'Person'"></i>
            <span>{{recipient.name}}</span>
            <i class="ion-plus-round"
              ng-click="addPossibleRecipientToChat(recipient);"></i>
          </div>
        </div>
        <div class="message-chosen-recipients-summary"
          ng-show="newMsgGroup && !newMsgGroupRecipientDecided &&currentRecipientSearch.search.length == 0">
          <div class="recipient-item"
            ng-repeat="recipient in chosenRecipients">
            <img src="img/user_images/profile_photo/{{recipient.currentProfilePhotoName}}"
                ng-if="recipient.listingType == 'Business'"/>
            <i class="ion-person" style="float: left;"
                ng-if="recipient.listingType == 'Person'"></i>
            <span>{{recipient.name}}</span>
            <i class="ion-minus-round"
              ng-click="chosenRecipients.splice(recipient, 1);"></i>
          </div>
        </div>
        <div ng-repeat="date in dates" class="message-date-wrapper">
            <span class="message-date-label-outer">
                <span class="message-date-label-inner">{{date.date}}</span>
            </span>
            <div ng-repeat="message in date.posts" class="message-wrapper">
                <div>
                    <div class="chat-bubble" ng-class="{'left':message.from=='self', 'right':message.from=='other', 'with-attachment': message._relatedItemId != null}">
                        <div class="message-sender" ng-show="message.from != 'self' && groupHasMoreThan2People">
                            <p>{{message._messageSenderProfileName}}</p>
                        </div>
                        <div class="message-detail" ng-class="{'with-attachment': message._relatedItemId != null}">
                            <span class="attachment-span" ng-show="message._relatedItemId != null" ng-click="goToAttachedListing(message);">
                              <img src="http://www.mynyte.co.uk/sneak-preview/img/user_images/cover_photo/{{message.relatedItemCoverPhotoName}}"
                                ng-if="message.relatedItemCoverPhotoName != null"/>
                              <span class="attachment-type-note"
                                ng-class="{'left-float': message.relatedItemCoverPhotoName == null}"
                                ng-show="message.relatedItemType == 'BusinessesA la Carte Menu'
                                  || message.relatedItemType == 'BusinessesTakeaway Menu'
                                  || message.relatedItemType == 'BusinessesOffers'
                                  || message.relatedItemType == 'Offer'
                                  || message.relatedItemType == 'BusinessesPhotos'
                                  || message.relatedItemType == 'BusinessesEvents'">
                                <span ng-show="message.relatedItemType == 'BusinessesTakeaway Menu'">Takeaway Menu</span>
                                <span ng-show="message.relatedItemType == 'BusinessesA la Carte Menu'">A la Carte Menu</span>
                                <span ng-show="message.relatedItemType == 'BusinessesOffers'">Business' Offers</span>
                                <span ng-show="message.relatedItemType == 'Offer'">Offer</span>
                                <span ng-show="message.relatedItemType == 'BusinessesPhotos'">Business' Photos</span>
                                <span ng-show="message.relatedItemType == 'BusinessesEvents'">Business' Events</span>
                              </span>
                              <span class="attachment-note"
                                ng-class="{'border-bottom': message.text != ''
                                    , 'left-float': message.relatedItemCoverPhotoName == null}">{{message.relatedItemName}} - {{message.relatedItemTown}}</span>
                              <span class="attachment-note-icon"
                                ng-show="message.relatedItemType == 'BusinessesA la Carte Menu'
                                  || message.relatedItemType == 'BusinessesTakeaway Menu'
                                  || message.relatedItemType == 'BusinessesOffers'
                                  || message.relatedItemType == 'Offer'
                                  || message.relatedItemType == 'BusinessesPhotos'
                                  || message.relatedItemType == 'BusinessesEvents'">
                                  <i 
                                    ng-class="{'ion-social-usd': message.relatedItemType == 'BusinessesOffers' ||  message.relatedItemType == 'Offer',
                                      'ion-calendar': message.relatedItemType == 'BusinessesEvents',
                                      'ion-ios-paper': message.relatedItemType == 'BusinessesA la Carte Menu' || message.relatedItemType == 'BusinessesTakeaway Menu',
                                      'ion-images': message.relatedItemType == 'BusinessesPhotos'}"></i>
                                </span>
                            </span>
                            <p>{{message.text}}</p>
                            <p class="time-label">
                                <i ng-class="{'ion-checkmark': message.messageReadState == 'Not Read', 'ion-checkmark-circled': message.messageReadState == 'Read By Some' || message.messageReadState == 'Read By All'}"></i>
                                <i ng-class="{'ion-checkmark-circled': message.messageReadState == 'Read By All'}"
                                    ng-show="message.messageReadState == 'Read By All'"></i>
                                {{message.timeString}}
                            </p>
                        </div>
                    </div>
                </div>
                <div class="cf"></div>
            </div>
          </div>
      </div>
      <!--
      <ion-infinite-scroll
       	ng-if="postsCompleted == false"
       	on-infinite="getPosts()"
       	distance="10%">
     	</ion-infinite-scroll>
        -->
   </ion-content>
    <div ng-if="rootScope.relListing != null" class="message-attachment">
        <img src="http://www.mynyte.co.uk/sneak-preview/img/user_images/cover_photo/{{rootScope.relListing.currentCoverPhotoName}}" />
        <i class="message-attachment-symbol-icon"
            ng-if="rootScope.relListing.relListingType != 'Business' && rootScope.relListing.relListingType != null"
            ng-class="{'ion-social-usd': rootScope.relListing.relListingType == 'BusinessesOffers' || rootScope.relListing.relListingType == 'Offer',
                        'ion-calendar': rootScope.relListing.relListingType == 'BusinessesEvents' || rootScope.relListing.relListingType == 'Event',
                        'ion-ios-paper': rootScope.relListing.relListingType == 'BusinessesA la Carte Menu' || rootScope.relListing.relListingType == 'BusinessesTakeaway Menu',
                        'ion-images': rootScope.relListing.relListingType == 'BusinessesPhotos'}"></i>
        <div class="message-attachment-info">
            <span class="listing-title">
                <span ng-if="rootScope.relListing.relListingType != null && rootScope.relListing.relListingType != 'Business'">
                    {{rootScope.relListing.relListingTypeAlias}} at&nbsp;
                </span>
                <b ng-if="rootScope.relListing.relListingType =='Offer' || rootScope.relListing.relListingType =='Event'">
                    {{rootScope.relListing.businessName}}
                </b>
                <b ng-if="rootScope.relListing.relListingType != 'Offer' && rootScope.relListing.relListingType != 'Event'">
                    {{rootScope.relListing.name}}
                </b>
            </span>
            <span class="listing-description">{{rootScope.relListing.description}}</span>
            <span class="listing-businessName"
                ng-if="rootScope.relListing.listingType != 'Offer' && rootScope.relListing.listingType != 'Event'">{{rootScope.relListing.businessName}}</span>
            <span class="listing-businessName"
                ng-if="rootScope.relListing.listingType == 'Offer' || rootScope.relListing.listingType == 'Event'">{{rootScope.relListing.name}}</span>
            <span class="listing-town">{{rootScope.relListing.town}}</span>
            <span ng-show="rootScope.relListing.date != null" class="listing-date">{{rootScope.relListing.date}}</span>
        </div>
        <button ng-click="cancelListingAttachment();">
          <i class="ion-close"></i>
        </button>
   </div>
   <div class="bar bar-footer bar-stable comment-stable-main">
    	<form  class="comment-form-main" method="post" ng-submit="addMesage(postForm.$valid)" name="postForm" novalidate>
            <div class="row small-font row-comment">
                <span class="col-80">
                	<label class="item item-input comment-div-label">
                        <textarea class="comment-main-text" required ng-model="datamessage" name="message" placeholder="{{rootScope.currentMessageInputPlaceholder}}" auto-focus></textarea>
                   	</label>
                </span>
                <span class="col-20">
                    <button ng-disabled="datamessage == '' && relListing == null"  class="button button-block button-assertive button-comment"><span class="icon ion-android-send"></span></button>
                </span>
            </div>
        </form>
	</div>
</ion-view>
